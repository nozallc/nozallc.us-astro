---
// LanguageToggle.astro
// Floating language toggle with glassmorphism, landing animation, and full accessibility
---

<button
	class="floating-language-toggle"
	id="languageToggle"
	aria-label="Switch language to Español"
	aria-pressed="false"
	type="button"
	title="Toggle between English and Español"
	data-landing-animation="true"
>
	<span class="toggle-label" aria-hidden="true">EN</span>
	<span class="toggle-divider" aria-hidden="true">/</span>
	<span class="toggle-label secondary" aria-hidden="true">ES</span>
</button>

<script>
	// Client-side language toggle logic with landing animation support
	const toggle = document.getElementById('languageToggle');

	if (toggle) {
		// Determine current language from URL
		function getCurrentLanguageFromUrl() {
			const pathname = window.location.pathname;
			if (pathname.startsWith('/es/') || pathname === '/es') {
				return 'es';
			}
			return 'en';
		}

		// Initialize toggle state from current URL
		const currentLang = getCurrentLanguageFromUrl();
		updateToggleState(currentLang);
		localStorage.setItem('preferredLanguage', currentLang);

		// Remove landing animation after it completes (2 seconds)
		// This ensures it only plays once on initial page load
		const animationDuration = 2000;
		setTimeout(() => {
			toggle.removeAttribute('data-landing-animation');
		}, animationDuration);

		// Handle click
		toggle.addEventListener('click', () => {
			const isSpanish = toggle.getAttribute('aria-pressed') === 'true';
			const newLang = isSpanish ? 'en' : 'es';
			updateToggleState(newLang);
			localStorage.setItem('preferredLanguage', newLang);

			// Announce change to screen readers
			const announcement = newLang === 'es'
				? 'Language switched to Spanish'
				: 'Language switched to English';
			announceToScreenReader(announcement);

			// Navigate to language-specific URL
			navigateToLanguage(newLang);
		});

		// Function to navigate to the language-specific URL
		function navigateToLanguage(lang) {
			const currentPath = window.location.pathname;

			// Remove existing language prefix if present
			let cleanPath = currentPath;
			if (currentPath.startsWith('/es/')) {
				cleanPath = currentPath.substring(3); // Remove /es/
			} else if (currentPath === '/es') {
				cleanPath = '/';
			}

			// Build new path with correct language prefix
			// English: no prefix (e.g., /contact)
			// Spanish: /es/ prefix (e.g., /es/contact)
			const newPath = lang === 'en' ? cleanPath : `/es${cleanPath}`;
			window.location.href = newPath;
		}

		// Handle keyboard (Enter and Space)
		toggle.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' || e.key === ' ') {
				e.preventDefault();
				toggle.click();
			}
		});

		// Function to update toggle state
		function updateToggleState(lang: string) {
			const isSpanish = lang === 'es';
			toggle.setAttribute('aria-pressed', isSpanish ? 'true' : 'false');

			if (isSpanish) {
				toggle.setAttribute('aria-label', 'Switch language to English');
			} else {
				toggle.setAttribute('aria-label', 'Switch language to Español');
			}

			// Store preference for use across pages
			document.documentElement.lang = lang;
			document.documentElement.setAttribute('data-lang', lang);
		}

		// Function to announce changes to screen readers (polite live region)
		function announceToScreenReader(message: string) {
			// Create or get aria-live region
			let liveRegion = document.getElementById('sr-announcement');
			if (!liveRegion) {
				liveRegion = document.createElement('div');
				liveRegion.id = 'sr-announcement';
				liveRegion.setAttribute('aria-live', 'polite');
				liveRegion.setAttribute('aria-atomic', 'true');
				liveRegion.className = 'sr-only';
				document.body.appendChild(liveRegion);
			}

			// Announce message
			liveRegion.textContent = message;

			// Clear after announcement is read
			setTimeout(() => {
				liveRegion.textContent = '';
			}, 2000);
		}
	}
</script>

<style is:global>
	/* Screen reader only text */
	.sr-only {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border-width: 0;
	}
</style>
